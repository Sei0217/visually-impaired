<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home | Object Recognition and Navigation for Visually Impaired Person</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* optional: mas kita ang annotated image */
    #imagePreview { max-width: 100%; border-radius: 8px; }
    .results-area ul { margin-top: .5rem; padding-left: 1.2rem; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <button class="menu-toggle"><i class="fas fa-bars"></i></button>
      <a style="color:#fff;text-decoration:none;" href="/index.html"><h1>Object Recognition and Navigation</h1></a>
      <nav>
        <ul id="navMenu">
          <li><a href="/index.html">Home</a></li>
          <li><a href="/information.html">Object information</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main style="padding-top:5vh" class="container">
    <section id="home" class="hero-section">
      <h2>Enhancing Object Recognition and Navigation for Visually Impaired Person using Deep Learning Algorithm</h2>
      <p>Integrating deep-learning object detection to deliver guidance and obstacle alerts.</p>

      <div class="feature-grid">
        <div class="feature-card" data-target="detect" data-action="capture">
          <i class="fas fa-camera"></i>
          <h3>Capture Image</h3>
          <p>Use your device camera to capture an object.</p>
        </div>
        <div class="feature-card" data-target="detect" data-action="upload">
          <i class="fas fa-upload"></i>
          <h3>Upload Image</h3>
          <p>Upload an image from your gallery for analysis.</p>
        </div>
        <div class="feature-card" data-target="information">
          <i class="fas fa-lightbulb"></i>
          <h3>Object information</h3>
          <p>Learn more about object recognition and navigation.</p>
        </div>
      </div>
    </section>

    <section id="detect" class="detection-section">
      <h2>Detect Object</h2>
      <div class="upload-area">
        <p>Select or capture an image of an object for analysis:</p>

        <!-- Important: Huwag gawing form para walang implicit submit -->
        <input type="file" id="imageInput" name="image" accept="image/*">
        <button id="startCameraBtn" class="btn primary-btn"><i class="fas fa-camera"></i> Use Camera</button>
        <button id="uploadBtn" class="btn primary-btn"><i class="fas fa-upload"></i> Upload Image</button>

        <div class="image-preview-container" data-pi-ip="10.0.0.103">
          <div id="loadingSpinner" class="spinner-container" style="display:none;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
              <linearGradient id="a12"><stop offset="0" stop-color="#28A745" stop-opacity="0"/>
                <stop offset="1" stop-color="#28A745"/></linearGradient>
              <circle fill="none" stroke="url(#a12)" stroke-width="15" stroke-linecap="round"
                      stroke-dasharray="0 44 0 44 0 44 0 44 0 360" cx="100" cy="100" r="70">
                <animateTransform type="rotate" attributeName="transform" calcMode="discrete"
                                  dur="2" values="360;324;288;252;216;180;144;108;72;36" repeatCount="indefinite"/>
              </circle>
            </svg>
            <p>Analyzing...</p>
          </div>
          <video id="videoPreview" autoplay playsinline style="display:none"></video>
          <img id="imagePreview" alt="Preview">
          <p id="previewPlaceholder">No image selected</p>
          <button id="captureBtn" class="btn" style="display:none;">
            <i class="fas fa-circle" style="margin:0!important;"></i>
          </button>
        </div>

        <button id="analyzeImageBtn" class="btn success-btn" disabled>
          <i class="fas fa-search"></i> Analyze Image
        </button>
      </div>

      <div id="resultsSection" class="results-area" style="display:none;">
        <h3>Analysis Results</h3>
        <div class="result-item"><strong>Object Type:</strong> <span id="diseaseType"></span></div>
        <div class="result-item"><strong>Confidence Score:</strong> <span id="confidenceScore"></span></div>
      </div>
    </section>
  </main>

  <footer><div class="container"><p>&copy; 2025 Object Recognition and Navigation. All rights reserved.</p></div></footer>

  <!-- Fullscreen image modal -->
  <div id="imageModal" class="modal"
       style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;justify-content:center;align-items:center;">
    <img id="modalImg" src="" style="object-fit:contain;object-position:center;width:100%;max-height:90%;">
  </div>

  <script>
    /* ===== Smooth section scroll & feature actions ===== */
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('.feature-card').forEach(card => {
        card.addEventListener('click', () => {
          const targetId = card.getAttribute('data-target');
          const action   = card.getAttribute('data-action');
          const target   = document.getElementById(targetId);
          if (target) target.scrollIntoView({ behavior:'smooth', block:'start' });
          if (action === 'capture') document.getElementById('startCameraBtn').click();
          if (action === 'upload')  document.getElementById('uploadBtn').click();
          if (targetId === 'information') window.location.href = '/information';
        });
      });

      const hash = window.location.hash;
      if (hash) {
        const t = document.getElementById(hash.substring(1));
        if (t) setTimeout(()=>t.scrollIntoView({behavior:'smooth',block:'start'}), 100);
      }
    });
  </script>

  <!-- ========= Core App Logic (combined) ========= -->
  <script type="module">
    const imageInput  = document.getElementById('imageInput');
    const placeholder = document.getElementById('previewPlaceholder');
    const analyzeBtn  = document.getElementById('analyzeImageBtn');
    const resultsBox  = document.getElementById('resultsSection');
    const videoPrev   = document.getElementById('videoPreview');
    const imagePrev   = document.getElementById('imagePreview');
    const startBtn    = document.getElementById('startCameraBtn');
    const captureBtn  = document.getElementById('captureBtn');
    const uploadBtn   = document.getElementById('uploadBtn');

    const diseaseTypeEl      = document.getElementById('diseaseType');
    const confidenceScoreEl  = document.getElementById('confidenceScore');

    let stream = null;
    let currentImageFile = null;
    let currentAnalysis  = null;

    /* --------- HARD GUARDS: never auto-analyze --------- */
    let isAnalyzing   = false;  // single-flight
    let ALLOW_PROCESS = false;  // Analyze button only

    // Prevent any implicit 'submit'
    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', e => e.preventDefault(), { capture:true });
    });
    if (analyzeBtn && analyzeBtn.type !== 'button') analyzeBtn.type = 'button';

    /* --------- Preview-only handlers --------- */
    imageInput.addEventListener('change', e => setPreviewFile(e.target.files?.[0]));

    uploadBtn.addEventListener('click', () => {
      imageInput.click();
      stopCamera();
      videoPrev.style.display = 'none';
      imagePrev.style.display = 'block';
      placeholder.style.display = 'none';
      captureBtn.style.display = 'none';
    });

    imagePrev.addEventListener('click', () => {
      if (imagePrev.src) openFullscreen(imagePrev.src);
    });

    function setPreviewFile(file) {
      if (!file) return;
      currentImageFile = file;
      const reader = new FileReader();
      reader.onload = e => {
        imagePrev.src = e.target.result;
        imagePrev.style.display = 'block';
        placeholder.style.display = 'none';
        analyzeBtn.disabled = false;
        resultsBox.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    /* --------- Camera capture --------- */
    startBtn.addEventListener('click', async () => {
      try {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        } catch {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
        }
      } catch (err) {
        console.error("Camera access error:", err);
        alert("Unable to access your camera. Please allow permissions.");
        return;
      }
      videoPrev.srcObject = stream;
      videoPrev.style.display = 'block';
      startBtn.style.display = 'none';
      captureBtn.style.display = 'inline-flex';
      placeholder.style.display = 'none';
      analyzeBtn.disabled = true;
      imagePrev.style.display = 'none';
      currentImageFile = null;
    });

    captureBtn.addEventListener('click', () => {
      captureBtn.style.display = 'none';
      const canvas = document.createElement('canvas');
      canvas.width  = videoPrev.videoWidth;
      canvas.height = videoPrev.videoHeight;
      canvas.getContext('2d').drawImage(videoPrev, 0, 0);
      canvas.toBlob(blob => {
        currentImageFile = new File([blob], 'capture.jpg', { type: 'image/jpeg' });
        const reader = new FileReader();
        reader.onload = e => {
          imagePrev.src = e.target.result;
          imagePrev.style.display = 'block';
          videoPrev.style.display = 'none';
          startBtn.style.display = 'inline-flex';
          analyzeBtn.disabled = false;
        };
        reader.readAsDataURL(blob);
      }, 'image/jpeg');
      stopCamera();
    });

    function stopCamera() { stream?.getTracks().forEach(t => t.stop()); }

    /* --------- Results list (fix NaN%) --------- */

    /* --------- Analyze button: the ONLY path that can process() --------- */
    if (!window.__wiredAnalyze) {
      window.__wiredAnalyze = true;
      analyzeBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (isAnalyzing) return;
        if (!currentImageFile) { alert('Please select or capture an image first.'); return; }

        isAnalyzing   = true;
        ALLOW_PROCESS = true;

        // lock UI + spinner
        const sp = document.getElementById('loadingSpinner');
        if (sp) sp.style.display = 'flex';
        [startBtn, uploadBtn, captureBtn, analyzeBtn].forEach(b=>b && (b.disabled = true));
        resultsBox.style.display = 'none';

        try {
          const fd = new FormData();
          fd.append('image', currentImageFile, currentImageFile.name || 'upload.jpg');
          const ok = await process(fd);
          if (!ok) console.warn('Analyze failed.');
        } finally {
          if (sp) sp.style.display = 'none';
          [startBtn, uploadBtn, captureBtn, analyzeBtn].forEach(b=>b && (b.disabled = false));
          isAnalyzing = false;
        }
      });
    }

    /* --------- Core request (gated; hard timeout only) --------- */
    async function process(formData) {
      if (!ALLOW_PROCESS) { console.warn('process() ignored: not from Analyze'); return false; }
      try {
        const uploadURL = '/api/detect'; // works both localhost & vercel
        const ac = new AbortController();
        const t  = setTimeout(() => ac.abort('timeout'), 180000); // 3 min
        const res = await fetch(uploadURL, { method: 'POST', body: formData, signal: ac.signal })
            .finally(()=>clearTimeout(t));

        if (!res.ok) {
          const text = await res.text().catch(()=> '');
          alert(`❌ Failed to analyze image.\nHTTP ${res.status} ${text}`);
          return false;
        }

        const data = await res.json();
        const annotated = data.image_base64 || data.annotated_image_url || '';
        if (annotated) imagePrev.src = annotated;

        currentAnalysis = { ...data, annotated_image_url: annotated || imagePrev.src };

        // top fields (compatible with unified main.py)
        const objType = currentAnalysis.object_type ?? '';
        const topPct  = Number.isFinite(Number(currentAnalysis.confidence_score))
                        ? Number(currentAnalysis.confidence_score)
                        : 0;
        diseaseTypeEl.textContent     = objType || (currentAnalysis?.detections?.[0]?.label ?? '');
        confidenceScoreEl.textContent = `${topPct}%`;

        imagePrev.style.display = 'block';
        resultsBox.style.display = 'block';
        updateDetectionsList(currentAnalysis);

        // optional: history hook if present
        if (window.appendToHistory && (currentAnalysis?.detections?.length || 0) > 0) {
          window.appendToHistory(currentAnalysis);
        }
        return true;

      } catch (err) {
        if (err?.name === 'AbortError') { alert('❌ Analyze timed out. Please try again.'); return false; }
        console.error(err);
        alert('❌ Failed to analyze image. (Network error)');
        imagePrev.style.display  = 'block';
        resultsBox.style.display = 'block';
        return false;
      } finally {
        ALLOW_PROCESS = false; // gate closes after each analyze
      }
    }

    /* --------- Fullscreen viewer --------- */
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    function openFullscreen(src) { modalImg.src = src; modal.style.display = 'flex'; }
    modal.addEventListener('click', () => { modal.style.display = 'none'; modalImg.src = ''; });
    window.openFullscreen = openFullscreen;
  </script>

  <!--
<script>
(function () {
  function byId(id) { return document.getElementById(id); }

  var container = document.querySelector('.image-preview-container');
  if (!container) return;

  var PI_IP = container.getAttribute('data-pi-ip') || '10.0.0.103';
  var STREAM_URL = 'http://' + PI_IP + ':3001/video';
  var SNAP_URL   = 'http://' + PI_IP + ':3001/snapshot.jpg';

  var uploadBtn  = byId('uploadBtn');       // may exist
  var startBtn   = byId('startCameraBtn');  // may exist
  var captureBtn = byId('captureBtn');
  var analyzeBtn = byId('analyzeImageBtn');
  var videoPrev  = byId('videoPreview');    // keep hidden; we use PiCam
  var imagePrev  = byId('imagePreview');
  var spinner    = byId('loadingSpinner');
  var placeholder= byId('previewPlaceholder');

  // Ensure we have an <img id="piStream"> right after #videoPreview
  var streamImg = byId('piStream');
  if (!streamImg) {
    streamImg = document.createElement('img');
    streamImg.id = 'piStream';
    streamImg.alt = 'PiCam live';
    streamImg.style.display = 'none';
    streamImg.style.maxWidth = '100%';
    streamImg.style.borderRadius = '8px';
    if (videoPrev && videoPrev.parentNode) {
      videoPrev.parentNode.insertBefore(streamImg, imagePrev || videoPrev.nextSibling);
    } else {
      // fallback: append to container
      container.insertBefore(streamImg, imagePrev || null);
    }
  }

  function setBusy(busy) {
    if (spinner) spinner.style.display = busy ? 'flex' : 'none';
    if (placeholder) {
      var anyShown = (streamImg.style.display !== 'none') || (imagePrev && imagePrev.style.display !== 'none');
      placeholder.style.display = busy ? 'none' : (anyShown ? 'none' : 'block');
    }
  }

  function startLive() {
    setBusy(true);
    if (imagePrev) { imagePrev.style.display = 'none'; }
    if (videoPrev) { videoPrev.style.display = 'none'; }

    streamImg.onload = function () { setBusy(false); };
    streamImg.onerror = function () {
      setBusy(false);
      if (placeholder) {
        placeholder.textContent = 'Cannot reach Pi /video. Test it directly: ' + STREAM_URL;
        placeholder.style.display = 'block';
      }
    };
    streamImg.src = STREAM_URL + '?ts=' + Date.now();
    streamImg.style.display = 'block';

    if (captureBtn) captureBtn.style.display = 'inline-flex';
    if (analyzeBtn) analyzeBtn.disabled = true;
  }

  function takePhoto() {
    setBusy(true);
    fetch(SNAP_URL + '?ts=' + Date.now(), { cache: 'no-store' })
      .then(function (resp) {
        if (!resp.ok) throw new Error('snapshot failed ' + resp.status);
        return resp.blob();
      })
      .then(function (blob) {
        if (imagePrev) {
          imagePrev.src = URL.createObjectURL(blob);
          imagePrev.style.display = 'block';
        }
        // hide live stream while viewing the still
        streamImg.src = '';
        streamImg.style.display = 'none';

        if (analyzeBtn) analyzeBtn.disabled = false;
        setBusy(false);
      })
      .catch(function (err) {
        console.error(err);
        if (placeholder) {
          placeholder.textContent = 'Snapshot failed. Try opening: ' + SNAP_URL;
          placeholder.style.display = 'block';
        }
        setBusy(false);
      });
  }

  // Wire whichever start button exists
  if (uploadBtn)  uploadBtn.addEventListener('click', function (e) { e.preventDefault(); startLive(); });
  if (startBtn)   startBtn.addEventListener('click',  function (e) { e.preventDefault(); startLive(); });
  if (captureBtn) captureBtn.addEventListener('click',function (e) { e.preventDefault(); takePhoto(); });
})();
</script>

<script>
(function () {
  // 1) Hard-disable laptop webcam on this page
  try {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      var _origGUM = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
      navigator.mediaDevices.getUserMedia = function (constraints) {
        if (constraints && (constraints.video || (constraints.mediaSource === 'camera'))) {
          console.warn('Blocked getUserMedia(video); using PiCam instead.');
          return Promise.reject(new Error('Laptop webcam disabled: using PiCam stream instead.'));
        }
        return _origGUM(constraints);
      };
    }
  } catch (e) { console.warn('GUM override failed', e); }

  // 2) Stop any already-open local webcam tracks and hide <video> elements
  function stopAllLocalCams() {
    var vids = document.querySelectorAll('video');
    vids.forEach(function (v) {
      try {
        if (v.srcObject && v.srcObject.getTracks) {
          v.srcObject.getTracks().forEach(function (t) { try { t.stop(); } catch (_e) {} });
        }
      } catch (_e) {}
      v.srcObject = null;
      v.style.display = 'none';
    });
  }
  stopAllLocalCams();

  // 3) Scrub existing event listeners on buttons by cloning them
  function scrub(id) {
    var el = document.getElementById(id);
    if (!el || !el.parentNode) return null;
    var clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);
    return clone;
  }
  var uploadBtn  = scrub('uploadBtn') || scrub('startCameraBtn');
  var captureBtn = scrub('captureBtn');

  var container   = document.querySelector('.image-preview-container');
  if (!container) return;

  var PI_IP      = container.getAttribute('data-pi-ip') || '10.0.0.103';
  var STREAM_URL = 'http://' + PI_IP + ':3001/video';
  var SNAP_URL   = 'http://' + PI_IP + ':3001/snapshot.jpg';

  var streamImg   = document.getElementById('piStream');
  var imagePrev   = document.getElementById('imagePreview');
  var spinner     = document.getElementById('loadingSpinner');
  var placeholder = document.getElementById('previewPlaceholder');
  var analyzeBtn  = document.getElementById('analyzeImageBtn');
  var videoPrev   = document.getElementById('videoPreview');
  if (videoPrev) videoPrev.style.display = 'none';

  if (!streamImg) {
    streamImg = document.createElement('img');
    streamImg.id = 'piStream';
    streamImg.alt = 'PiCam live';
    streamImg.style.display = 'none';
    streamImg.style.maxWidth = '100%';
    streamImg.style.borderRadius = '8px';
    container.insertBefore(streamImg, imagePrev || null);
  }

  function setBusy(b) {
    if (spinner) spinner.style.display = b ? 'flex' : 'none';
    if (placeholder) {
      var anyShown = (streamImg.style.display !== 'none') || (imagePrev && imagePrev.style.display !== 'none');
      placeholder.style.display = b ? 'none' : (anyShown ? 'none' : 'block');
    }
  }

  function startLive() {
    setBusy(true);
    stopAllLocalCams();
    if (imagePrev) imagePrev.style.display = 'none';

    streamImg.onload = function () { setBusy(false); };
    streamImg.onerror = function () {
      setBusy(false);
      if (placeholder) {
        placeholder.textContent = 'Cannot reach Pi /video. Open: ' + STREAM_URL;
        placeholder.style.display = 'block';
      }
    };
    streamImg.src = STREAM_URL + '?ts=' + Date.now();
    streamImg.style.display = 'block';

    if (captureBtn) captureBtn.style.display = 'inline-flex';
    if (analyzeBtn) analyzeBtn.disabled = true;
  }

  function takePhoto() {
    setBusy(true);
    fetch(SNAP_URL + '?ts=' + Date.now(), { cache: 'no-store' })
      .then(function (resp) { if (!resp.ok) throw new Error('snapshot ' + resp.status); return resp.blob(); })
      .then(function (blob) {
        if (imagePrev) {
          imagePrev.src = URL.createObjectURL(blob);
          imagePrev.style.display = 'block';
        }
        streamImg.src = '';
        streamImg.style.display = 'none';
        if (analyzeBtn) analyzeBtn.disabled = false;
      })
      .catch(function (e) {
        console.error(e);
        if (placeholder) { placeholder.textContent = 'Snapshot failed. Try ' + SNAP_URL; placeholder.style.display = 'block'; }
      })
      .finally(function () { setBusy(false); });
  }

  if (uploadBtn)  uploadBtn.addEventListener('click', function (e) { e.preventDefault(); startLive(); });
  if (captureBtn) captureBtn.addEventListener('click', function (e) { e.preventDefault(); takePhoto(); });
})();
</script>
-->
</body>
</html>
